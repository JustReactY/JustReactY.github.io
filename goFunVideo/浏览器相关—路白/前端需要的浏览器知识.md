# 前端需要的浏览器知识

## 浏览器BOM对象

- window

```
- 窗口位置

screenLeft
screenTop
screenX	
screenY	
moveBy(x,y)
moveTo(x,y)


- 窗口大小

innerWidth
innerHeight	

outerWidth
outerHeight	

resizeTo(width, height)
resizeBy(width, height)

- 定时器

setTimeout
setInterval
```

- location

```
hash
host
hostname
href
pathname
port
protocol
search
```

- navigation
- screen
- history

## 浏览器事件

- 阻止冒泡

``` js
e.stopPropagation()

ev.cancelBubble = true; // IE
```

- 阻止默认行为

``` js
e.preventDefault()

event.returnValue = false; // IE
```

- 封装一个兼容API - 优雅降级

``` js
// 阻止事件 (主要是事件冒泡，因为IE不支持事件捕获)
function stopPropagation(ev) {
    if (ev.stopPropagation) {
        ev.stopPropagation(); // 标准w3c
    } else {
        ev.cancelBubble = true; // IE
    }
}
// 取消事件的默认行为
function preventDefault(event) {
    if (event.preventDefault) {
        event.preventDefault(); // 标准w3c
    } else {
        event.returnValue = false; // IE
    }
}
```

- 绑定事件

> attachEvent——兼容：IE7、IE8； 不支持第三个参数来控制在哪个阶段发生，默认是绑定在冒泡阶段
addEventListener——兼容：firefox、chrome、IE、safari、opera；

- 封装一个兼容绑定事件API

``` js
class BomEvent {
    constructor(element) {
        this.element = element;
    }

    addEvent(type, handler) {
        if (this.element.addEventListener) {
            //事件类型、需要执行的函数、是否捕捉
            this.element.addEventListener(type, handler, false);
        } else if (this.element.attachEvent) {
            this.element.attachEvent('on' + type, function () {
                handler.call(element);
            });
        } else {
            this.element['on' + type] = handler;
        }
    }

    removeEvent(type, handler) {
        if (this.element.removeEnentListener) {
            this.element.removeEnentListener(type, handler, false);
        } else if (element.datachEvent) {
            this.element.detachEvent('on' + type, handler);
        } else {
            this.element['on' + type] = null;
        }
    }
}
```

## 浏览器请求

**api**

1. XMLHTTPRequest

2. fetch

- 默认不带cookie
- 错误不会reject
- 不支持超时设置
- 需要借用AbortController中止fetch

**常见状态码**

- 200	get 成功
- 201 post 成功
- 301 永久重定向
- 302	临时重定向
- 304 协商缓存 服务器文件未修改
- 400	客户端请求有语法错误，不能被服务器识别
- 403	服务器受到请求，但是拒绝提供服务，可能是跨域
- 404	请求的资源不存在
- 405 请求的method不允许
- 500	服务器发生不可预期的错误


**XHR 请求**

``` js
let xhr = new XMLHttpRequest();
xhr.open('GET', 'http://domain/service');

// request state change event
xhr.onreadystatechange = function () {
    // request completed?
    if (xhr.readyState !== 4) return;

    if (xhr.status === 200) {
        // request successful - show response
        console.log(xhr.responseText);
    } else {
        // request error
        console.log('HTTP error', xhr.status, xhr.statusText);
    }
};

// xhr.timeout = 3000; // 3 seconds
// xhr.ontimeout = () => console.log('timeout', xhr.responseURL);

// progress事件可以报告长时间运行的文件上传
// xhr.upload.onprogress = p => {
//     console.log(Math.round((p.loaded / p.total) * 100) + '%');
// }

// start request
xhr.send();

```

**fetch 请求**

``` js
fetch(
        'http://domain/service', {
            method: 'GET'
        }
    )
    .then(response => {
        if (response.ok) {
            return response.json();
        }
        throw new Error('Network response was not ok.');
    })
    .then(json => console.log(json))
    .catch(error => console.error('error:', error));
```

> 错误不会reject
> HTTP错误（例如404 Page Not Found 或 500 Internal Server Error）不会导致Fetch返回的Promise标记为reject；.catch()也不会被执行。
> 想要精确的判断 fetch是否成功，需要包含 promise resolved 的情况，此时再判断 response.ok是不是为 true


``` js
function fetchTimeout(url, init, timeout = 3000) {
    return new Promise((resolve, reject) => {
        fetch(url, init)
            .then(resolve)
            .catch(reject);
        setTimeout(reject, timeout);
    })
}

```

> 不支持直接设置超时, 可以用promise

``` js
const controller = new AbortController();

fetch(
        'http://domain/service', {
            method: 'GET',
            signal: controller.signal
        })
    .then(response => response.json())
    .then(json => console.log(json))
    .catch(error => console.error('Error:', error));

controller.abort();
```

> 中止fetch

## 手写简易ajax
[codepen](https://codepen.io/justreacty/pen/GRMdwOQ)